@page "/budgets"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@using SmartBudget.DTOs
@using SmartBudget.Interfaces
@using SmartBudget.Services
@using Microsoft.JSInterop
@inject IBudgetService BudgetService
@inject ICategoryService CategoryService
@inject IJSRuntime JS
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Budgets</PageTitle>

<div class="container-fluid py-4 px-lg-4">
    <!-- Page Header -->
    <div class="sb-page-header d-flex justify-content-between align-items-center">
        <div>
            <h2>üìã Budgets</h2>
            <p>Set spending limits for each category</p>
        </div>
        <div class="sb-stat-card" style="background:rgba(255,255,255,0.15);border:none;color:#fff;min-width:100px;">
            <div class="sb-stat-value" style="color:#fff;">@budgets.Count</div>
            <div class="sb-stat-label" style="color:rgba(255,255,255,0.8);">Active</div>
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(error))
    {
        <div class="alert alert-danger">@error</div>
    }
    @if (!string.IsNullOrWhiteSpace(message))
    {
        <div class="alert alert-success">@message</div>
    }

    <!-- Add/Edit Budget Card -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="fw-bold mb-3">@((editingId is null) ? "Add New Budget" : "Edit Budget")</h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">Category</label>
                    <select class="form-select" @bind="form.CategoryId" disabled="@isBusy">
                        <option value="0">Select a category...</option>
                        @foreach (var c in categories)
                        {
                            <option value="@c.Id">@c.Name</option>
                        }
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label">Month</label>
                    <input class="form-control" type="number" min="1" max="12"
                           @bind="form.Month" disabled="@isBusy" />
                </div>

                <div class="col-md-2">
                    <label class="form-label">Year</label>
                    <input class="form-control" type="number" min="2000" max="2100"
                           @bind="form.Year" disabled="@isBusy" />
                </div>

                <div class="col-md-2">
                    <label class="form-label">Limit</label>
                    <div class="input-group">
                        <span class="input-group-text" style="background:var(--sb-primary-bg);border-color:var(--sb-gray-200);font-weight:700;color:var(--sb-primary);">$</span>
                        <input class="form-control" type="number" step="0.01" min="0"
                               @bind="form.LimitAmount" disabled="@isBusy" />
                    </div>
                </div>

                <div class="col-md-3 d-flex gap-2">
                    @if (editingId is null)
                    {
                        <button class="btn btn-primary flex-fill" @onclick="SaveNew" disabled="@isBusy">+ Add Budget</button>
                    }
                    else
                    {
                        <button class="btn btn-success flex-fill" @onclick="SaveEdit" disabled="@isBusy">Update</button>
                        <button class="btn btn-outline-secondary" @onclick="CancelEdit" disabled="@isBusy">‚úï</button>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Budgets Table -->
    <div class="card">
        <div class="card-body p-0">
            <div class="d-flex justify-content-between align-items-center px-4 py-3" style="border-bottom:1px solid var(--sb-gray-200);">
                <h5 class="mb-0 fw-bold">Your Budgets</h5>
            </div>

            @if (isBusy && budgets.Count == 0)
            {
                <div class="sb-empty-state">
                    <div class="sb-empty-icon">‚è≥</div>
                    <p>Loading budgets...</p>
                </div>
            }
            else if (budgets.Count == 0)
            {
                <div class="sb-empty-state">
                    <div class="sb-empty-icon">üìã</div>
                    <p>No budgets yet. Set your first spending limit above!</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th class="ps-4">Category</th>
                                <th>Month</th>
                                <th>Year</th>
                                <th class="text-end">Limit</th>
                                <th class="text-end">Remaining</th>
                                <th class="text-end">Status</th>
                                <th class="text-end pe-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var b in budgets)
                            {
                                var remaining = remainingByBudgetId.TryGetValue(b.Id, out var r) ? r : 0;
                                var isOver = remaining < 0;
                                <tr>
                                    <td class="ps-4 fw-semibold">@GetCategoryName(b.CategoryId)</td>
                                    <td>@(new DateTime(2000, b.Month, 1).ToString("MMM"))</td>
                                    <td>@b.Year</td>
                                    <td class="text-end">@b.LimitAmount.ToString("C")</td>
                                    <td class="text-end fw-bold" style="color:@(isOver ? "var(--sb-danger)" : "var(--sb-success)")">
                                        @remaining.ToString("C")
                                    </td>
                                    <td class="text-end">
                                        @if (isOver)
                                        {
                                            <span class="badge" style="background:var(--sb-danger-bg);color:var(--sb-danger);">Over Budget</span>
                                        }
                                        else
                                        {
                                            <span class="badge" style="background:var(--sb-success-bg);color:var(--sb-success);">On Track</span>
                                        }
                                    </td>
                                    <td class="text-end pe-4">
                                        <button class="btn btn-outline-primary btn-sm me-1"
                                                @onclick="() => StartEdit(b)" disabled="@isBusy">Edit</button>
                                        <button class="btn btn-outline-danger btn-sm"
                                                @onclick="() => Delete(b)" disabled="@isBusy">Delete</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private string? userId;

    private bool isBusy;
    private string message = "";
    private string error = "";

    private List<CategoryDto> categories = new();
    private List<BudgetDto> budgets = new();

    private BudgetDto form = new();
    private int? editingId = null;

    // Remaining budget per budgetId
    private Dictionary<int, decimal> remainingByBudgetId = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        var now = DateTime.Now;
        form.Month = now.Month;
        form.Year = now.Year;
        await LoadAll();
    }

    private async Task LoadAll()
    {
        try
        {
            isBusy = true;
            error = "";
            message = "";

            if (string.IsNullOrEmpty(userId))
            {
                error = "User not authenticated.";
                return;
            }
            categories = await CategoryService.GetCategoriesByUserAsync(userId);

            var budgetList = await BudgetService.GetUserBudgetsAsync(userId);
            budgets = budgetList.ToList();

            remainingByBudgetId.Clear();
            foreach (var b in budgets)
            {
                try
                {
                    remainingByBudgetId[b.Id] = await BudgetService.GetRemainingBudgetAsync(b.Id, userId!);
                }
                catch
                {
                    remainingByBudgetId[b.Id] = 0;
                }
            }
        }
        catch (Exception ex)
        {
            error = $"Could not load budgets: {ex.Message}";
        }
        finally
        {
            isBusy = false;
        }
    }

    private async Task SaveNew()
    {
        // Clear old alerts
        error = "";
        message = "";

        if (form.CategoryId <= 0)
        {
            error = "Please select a category.";
            return;
        }
        if (form.Month < 1 || form.Month > 12)
        {
            error = "Month must be between 1 and 12.";
            return;
        }
        if (form.Year < 2000 || form.Year > 2100)
        {
            error = "Year must be reasonable (2000‚Äì2100).";
            return;
        }
        if (form.LimitAmount <= 0)
        {
            error = "Limit must be greater than 0.";
            return;
        }

        // Prevent duplicates (same category + month + year)
        if (budgets.Any(x => x.CategoryId == form.CategoryId &&
                             x.Month == form.Month &&
                             x.Year == form.Year))
        {
            error = "You already have a budget for this category and month.";
            return;
        }

        try
        {
            isBusy = true;

            if (string.IsNullOrEmpty(userId))
            {
                error = "User not authenticated.";
                return;
            }
            await BudgetService.CreateBudgetAsync(form, userId);

            message = "Budget created.";
            form = new BudgetDto { Month = form.Month, Year = form.Year }; // keep month/year
            await LoadAll();
        }
        catch (Exception ex)
        {
            error = $"Could not create budget: {ex.Message}";
        }
        finally
        {
            isBusy = false;
        }
    }

    private void StartEdit(BudgetDto b)
    {
        editingId = b.Id;
        form = new BudgetDto
        {
            Id = b.Id,
            CategoryId = b.CategoryId,
            LimitAmount = b.LimitAmount,
            Month = b.Month,
            Year = b.Year
        };

        error = "";
        message = "";
    }

    private void CancelEdit()
    {
        editingId = null;

        var now = DateTime.Now;
        form = new BudgetDto { Month = now.Month, Year = now.Year };

        error = "";
        message = "";
    }

    private async Task SaveEdit()
    {
        if (editingId is null) return;

        // Clear old alerts
        error = "";
        message = "";

        if (form.LimitAmount <= 0)
        {
            error = "Limit must be greater than 0.";
            return;
        }

        try
        {
            isBusy = true;

            if (string.IsNullOrEmpty(userId))
            {
                error = "User not authenticated.";
                return;
            }
            await BudgetService.UpdateBudgetAsync(editingId.Value, form, userId);

            message = "Budget updated.";
            CancelEdit();
            await LoadAll();
        }
        catch (Exception ex)
        {
            error = $"Could not update budget: {ex.Message}";
        }
        finally
        {
            isBusy = false;
        }
    }

    private async Task Delete(BudgetDto b)
    {
        if (!await JS.InvokeAsync<bool>("confirm", $"Delete budget for {GetCategoryName(b.CategoryId)}?"))
            return;

        try
        {
            isBusy = true;
            error = "";
            message = "";

            if (string.IsNullOrEmpty(userId))
            {
                error = "User not authenticated.";
                return;
            }
            await BudgetService.DeleteBudgetAsync(b.Id, userId);

            message = "Budget deleted.";
            await LoadAll();
        }
        catch (Exception ex)
        {
            error = $"Could not delete budget: {ex.Message}";
        }
        finally
        {
            isBusy = false;
        }
    }

    private string GetCategoryName(int categoryId)
        => categories.FirstOrDefault(c => c.Id == categoryId)?.Name ?? $"Category #{categoryId}";
}
