@page "/expenses"
@attribute [Authorize]
@rendermode InteractiveServer
@using SmartBudget.Models
@using SmartBudget.DTOs
@using SmartBudget.Interfaces
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims

@* @attribute [Authorize] *@
@inject IExpenseService ExpenseService
@inject ICategoryService CategoryService
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Expenses - Smart Budget</PageTitle>

<div class="container-fluid py-4 px-lg-4">
    <!-- Page Header -->
    <div class="sb-page-header d-flex justify-content-between align-items-center">
        <div>
            <h2>üí∏ Expense Management</h2>
            <p>Track where your money is going in real-time</p>
        </div>
        <div class="sb-stat-card" style="background:rgba(255,255,255,0.15);border:none;color:#fff;min-width:140px;">
            <div class="sb-stat-value" style="color:#fff;">@monthlyTotal.ToString("C")</div>
            <div class="sb-stat-label" style="color:rgba(255,255,255,0.8);">This Month</div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Add Expense Form -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-body">
                    <h5 class="fw-bold mb-4">Log New Expense</h5>

                    <EditForm Model="newExpense" OnValidSubmit="HandleAddExpense" FormName="AddExpenseForm">
                        <DataAnnotationsValidator />

                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <InputText @bind-Value="newExpense.Description"
                                       class="form-control"
                                       placeholder="e.g. Weekly Groceries" />
                            <ValidationMessage For="@(() => newExpense.Description)" class="text-danger small" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Amount</label>
                            <div class="input-group">
                                <span class="input-group-text" style="background:var(--sb-primary-bg);border-color:var(--sb-gray-200);font-weight:700;color:var(--sb-primary);">$</span>
                                <InputNumber @bind-Value="newExpense.Amount"
                                             class="form-control" placeholder="0.00" />
                            </div>
                            <ValidationMessage For="@(() => newExpense.Amount)" class="text-danger small" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <InputSelect @bind-Value="newExpense.CategoryId"
                                         class="form-select">
                                <option value="0">Select Category...</option>
                                @foreach (var cat in categories)
                                {
                                    <option value="@cat.Id">@cat.Name</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => newExpense.CategoryId)" class="text-danger small" />
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Date</label>
                            <InputDate @bind-Value="newExpense.Date"
                                       class="form-control" />
                        </div>

                        <button type="submit" class="btn btn-primary btn-lg w-100">
                            + Add Expense
                        </button>
                    </EditForm>
                </div>
            </div>
        </div>

        <!-- Transactions Table -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body p-0">
                    <div class="d-flex justify-content-between align-items-center px-4 py-3" style="border-bottom:1px solid var(--sb-gray-200);">
                        <h5 class="mb-0 fw-bold">Recent Transactions</h5>
                        <span class="badge" style="background:var(--sb-primary-bg);color:var(--sb-primary);font-size:0.85rem;">
                            @userExpenses.Count entries
                        </span>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead>
                                <tr>
                                    <th class="ps-4">Date</th>
                                    <th>Description</th>
                                    <th>Category</th>
                                    <th class="text-end">Amount</th>
                                    <th class="text-center pe-4">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (userExpenses == null || !userExpenses.Any())
                                {
                                    <tr>
                                        <td colspan="5">
                                            <div class="sb-empty-state">
                                                <div class="sb-empty-icon">üí∏</div>
                                                <p>No expenses found. Start tracking your spending!</p>
                                            </div>
                                        </td>
                                    </tr>
                                }
                                else
                                {
                                    @foreach (var expense in userExpenses)
                                    {
                                        <tr>
                                            <td class="ps-4 text-muted small">@expense.Date.ToShortDateString()</td>
                                            <td>
                                                <div class="fw-semibold">@expense.Description</div>
                                            </td>
                                            <td>
                                                <span class="badge" style="background:var(--sb-info-bg);color:var(--sb-info);border:1px solid rgba(6,182,212,0.2);">
                                                    @expense.CategoryName
                                                </span>
                                            </td>
                                            <td class="text-end fw-bold" style="color:var(--sb-danger);">
                                                -@expense.Amount.ToString("C")
                                            </td>
                                            <td class="text-center pe-4">
                                                <button class="btn btn-sm btn-outline-danger"
                                                        @onclick="() => DeleteExpense(expense.Id)" title="Delete">
                                                    üóëÔ∏è
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    @code {
        private List<ExpenseDto> userExpenses = new();
        private List<CategoryDto> categories = new();
        private CreateExpenseDto newExpense = new() { Date = DateTime.Now };
        private decimal monthlyTotal;
        private string? userId;

        protected override async Task OnInitializedAsync()
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            await LoadData();
        }


    private async Task LoadData()
    {
        if (string.IsNullOrEmpty(userId))
        {
            return;
        }
        categories = await CategoryService.GetCategoriesByUserAsync(userId);
        userExpenses = await ExpenseService.GetExpensesByUserAsync(userId);

        monthlyTotal = await ExpenseService.GetTotalExpensesByUserAsync(
            userId,
            DateTime.Now.Month,
            DateTime.Now.Year
        );
    }



    private async Task HandleAddExpense()
    {
        Console.WriteLine("--- HandleAddExpense Triggered ---");

        if (newExpense.CategoryId == 0)
        {
            Console.WriteLine("Abort: Category is 0");
            return;
        }

        try
        {
            var result = await ExpenseService.CreateExpenseAsync(userId!, newExpense);
            @* var result = await ExpenseService.CreateExpenseAsync(null, newExpense); *@

            Console.WriteLine($"Saved Expense ID: {result.Id}");

            newExpense = new CreateExpenseDto { Date = DateTime.Now };
            await LoadData();
            Console.WriteLine($"Data Reloaded. Total Count: {userExpenses.Count}");

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"DATABASE ERROR: {ex.Message}");
        }
    }



    private async Task DeleteExpense(int id)
    {
        try
        {
            if (string.IsNullOrEmpty(userId))
                return;
            await ExpenseService.DeleteExpenseAsync(id, userId);
            await LoadData();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting expense: {ex.Message}");
        }
    }
}